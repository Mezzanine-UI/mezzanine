@use 'sass:map';
@use '~@mezzanine-ui/system/palette' as palette;
@use '~@mezzanine-ui/system/spacing' as spacing;
@use '~@mezzanine-ui/system/typography' as typography;
@use '~@mezzanine-ui/system/transition' as transition;
@use '~@mezzanine-ui/system/radius' as radius;
@use '~@mezzanine-ui/system/effect' as effect;
@use './table' as *;
@use '../button/utils' as button-utils;

$header-cell: (
  main: (
    typography: body-highlight,
    gap: spacing.semantic-variable(gap, tiny),
    padding: (
      horizontal: spacing.semantic-variable(padding, horizontal, comfort),
      vertical: spacing.semantic-variable(padding, vertical, calm),
    ),
    help-size: spacing.semantic-variable(size, element, base),
    sort-size: spacing.semantic-variable(size, element, base),
    menu-size: spacing.semantic-variable(size, element, base),
    resize: (
      width: spacing.semantic-variable(size, element, hairline),
      height: spacing.semantic-variable(size, element, relaxed),
    ),
  ),
  sub: (
    typography: body-highlight,
    gap: spacing.semantic-variable(gap, tiny),
    padding: (
      horizontal: spacing.semantic-variable(padding, horizontal, comfort),
      vertical: spacing.semantic-variable(padding, vertical, base),
    ),
    help-size: spacing.semantic-variable(size, element, base),
    sort-size: spacing.semantic-variable(size, element, base),
    menu-size: spacing.semantic-variable(size, element, base),
    resize: (
      width: spacing.semantic-variable(size, element, hairline),
      height: spacing.semantic-variable(size, element, relaxed),
    ),
  ),
);

$content-cell: (
  main: (
    typography: body,
    padding: (
      horizontal: spacing.semantic-variable(padding, horizontal, comfort),
      vertical: spacing.semantic-variable(padding, vertical, calm),
    ),
  ),
  sub: (
    typography: body,
    padding: (
      horizontal: spacing.semantic-variable(padding, horizontal, comfort),
      vertical: spacing.semantic-variable(padding, vertical, base),
    ),
  ),
);

$icon-size: spacing.semantic-variable(size, element, base);
$action-height: spacing.semantic-variable(size, element, gentle);
$sticky-cell-z-index: 1;

@mixin text-color {
  color: palette.semantic-variable(text, neutral-solid);
}

@mixin surface-bg {
  background-color: palette.semantic-variable("background", base);
}

@mixin header-bg {
  background-color: palette.semantic-variable("background", neutral-ghost);
}

@mixin highlight-bg {
  background-color: palette.semantic-variable("background", neutral-faint);
}

@mixin active-bg {
  background-color: palette.semantic-variable("background", brand-ghost);
}

@mixin active-hover-bg {
  background-color: palette.semantic-variable("background", brand-subtle);
}

@mixin icon-size {
  width: $icon-size;
  height: $icon-size;
}

@mixin fixed-column-shadow($direction: 'start') {
  &::after {
    position: absolute;
    inset-block: 0;
    width: 10px;
    content: '';
    pointer-events: none;
    transition: transition.standard(box-shadow);

    @if $direction == 'start' {
      inset-inline-end: 0;
      transform: translateX(100%);
    } @else {
      inset-inline-start: 0;
      transform: translateX(-100%);
    }
  }
}

@mixin fixed-column-shadow-active($direction: 'start') {
  &::after {
    @if $direction == 'start' {
      box-shadow: inset 8px 0 8px -8px palette.semantic-variable(shadow, dark-light);
    } @else {
      box-shadow: inset -8px 0 8px -8px palette.semantic-variable(shadow, dark-light);
    }
  }
}

.#{$scroll-container-prefix} {
  position: relative;
  overflow: auto;
  width: 100%;
  max-height: var(--table-scroll-y, auto);
  scrollbar-width: thin;

  &::-webkit-scrollbar {
    width: 0;
    height: 8px;

    @media (hover: none) and (pointer: coarse) {
      display: none;
      height: 0;
    }
  }

  &::-webkit-scrollbar-thumb {
    background: palette.semantic-variable("background", neutral-strong);
    border-radius: radius.variable(full);
  }

  &::-webkit-scrollbar-track {
    background: palette.semantic-variable("background", neutral-ghost);
  }
}

.#{$prefix} {
  box-sizing: border-box;
  width: 100%;
  min-width: var(--table-scroll-x, 100%);
  border-collapse: separate;
  border-spacing: 0;
  table-layout: fixed;

  @include text-color;
  @include surface-bg;

  * {
    box-sizing: border-box;
  }

  th,
  td {
    border-bottom: 1px solid palette.semantic-variable(separator, neutral-faint);
  }

  &--sticky {
    thead {
      position: sticky;
      top: 0;
      z-index: calc(#{$sticky-cell-z-index} + 2);
    }
  }

  &--main {
    th {
      @include typography.semantic-variable(map.get($header-cell, main, typography));

      padding: map.get($header-cell, main, padding, vertical) map.get($header-cell, main, padding, horizontal);
      gap: map.get($header-cell, main, gap);
    }

    td {
      @include typography.semantic-variable(map.get($content-cell, main, typography));

      padding: 0 map.get($content-cell, main, padding, horizontal);
    }

    .#{$resize-handle-prefix} {
      --mzn-table-resize-handle-width: #{map.get($header-cell, main, resize, width)};
      --mzn-table-resize-handle-height: #{map.get($header-cell, main, resize, height)};
    }
  }

  &--sub {
    th {
      @include typography.semantic-variable(map.get($header-cell, sub, typography));

      padding: map.get($header-cell, sub, padding, vertical) map.get($header-cell, sub, padding, horizontal);
      gap: map.get($header-cell, sub, gap);
    }

    td {
      @include typography.semantic-variable(map.get($content-cell, sub, typography));

      padding: 0 map.get($content-cell, sub, padding, horizontal);
    }

    .#{$resize-handle-prefix} {
      --mzn-table-resize-handle-width: #{map.get($header-cell, sub, resize, width)};
      --mzn-table-resize-handle-height: #{map.get($header-cell, sub, resize, height)};
    }
  }

  // Loading state
  &--loading {
    pointer-events: none;
    opacity: 0.6;
  }
}

.#{$header-prefix} {
  @include header-bg;

  &__cell {
    position: relative;
    box-sizing: border-box;
    text-align: start;
    vertical-align: middle;

    @include header-bg;

    &--fixed {
      position: sticky;
      z-index: 2;

      @include header-bg;
    }
  }

  &__cell-content {
    width: 100%;
    display: flex;
    flex-flow: row;
    align-items: center;
    justify-content: space-between;
  }

  &__cell-actions {
    flex: 1;
    display: flex;
    flex-flow: row;
    gap: spacing.semantic-variable(gap, tiny);
    align-items: center;
    justify-content: flex-start;
  }

  &__cell-title {
    @include typography.overflow-ellipsis();

    color: palette.semantic-variable(text, neutral-strong);
  }

  &__cell-icon {
    border: none;
    border-radius: radius.variable(base);
    width: spacing.semantic-variable(size, element, base);
    height: spacing.semantic-variable(size, element, base);
    color: palette.semantic-variable(icon, neutral-light);
    transition: transition.standard(color, fast);

    &:hover {
      color: palette.semantic-variable(icon, neutral-bold);
    }

    &:focus-visible {
      outline: none;
      box-shadow: effect.variable(focus, primary);
    }
  }
}

.#{$body-prefix} {
  &__virtual-container {
    position: relative;
    width: 100%;
  }

  &__row {
    @include surface-bg();

    &--highlight {
      td {
        @include highlight-bg;
      }
    }

    &--selected {
      td {
        @include active-bg();
      }

      &:hover,
      &.#{$body-prefix}__row--highlight {
        td {
          @include active-hover-bg();
        }
      }
    }

    &--dragging {
      filter: drop-shadow(0 4px 20px palette.semantic-variable(shadow, dark));
      width: 100%;
      display: flex;
      align-items: center;
      border-bottom: 1px solid palette.semantic-variable(separator, neutral-faint);

      td {
        border-bottom: none;
      }
    }

    &--adding {
      td {
        @include active-bg;
      }
    }

    &--deleting {
      td {
        background-color: palette.semantic-variable("background", error-ghost);
      }
    }

    &--fading-out {
      opacity: 0;
      transition: transition.entrance(opacity, moderate);

      td {
        background-color: palette.semantic-variable("background", error-ghost);
      }
    }
  }

  &__cell {
    text-align: start;
    vertical-align: middle;
  }

  &__cell-content {
    display: flex;
    align-items: center;
    min-width: 0;
  }

  &__empty {
    td {
      text-align: center;
      vertical-align: middle;

      @include surface-bg();
    }
  }
}

.#{$cell-prefix} {
  @include surface-bg();

  &--ellipsis {
    @include typography.overflow-ellipsis();
  }

  &--align-start {
    justify-content: flex-start;
    text-align: start;
  }

  &--align-center {
    justify-content: center;
    text-align: center;
  }

  &--align-end {
    justify-content: flex-end;
    text-align: end;
  }

  &--highlight {
    @include highlight-bg();
  }

  &--fixed {
    position: sticky;
  }

  &--fixed-start {
    inset-inline-start: var(--fixed-start-offset, 0);
    z-index: calc(#{$sticky-cell-z-index} + 1);

    @include fixed-column-shadow('start');
  }

  &--fixed-end {
    inset-inline-end: var(--fixed-end-offset, 0);
    z-index: $sticky-cell-z-index;

    @include fixed-column-shadow('end');
  }

  &--fixed-shadow {
    @include fixed-column-shadow-active('start');
  }

  &--fixed-end#{&}--fixed-shadow {
    @include fixed-column-shadow-active('end');
  }

  &__content {
    display: block;
  }
}

.#{$prefix}__drag-handle-cell {
  box-sizing: border-box;
  text-align: center;
  vertical-align: middle;
}

.#{$prefix}__drag-handle {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  cursor: grab;

  &:active {
    cursor: grabbing;
  }
}

.#{$prefix}__selection-column {
  box-sizing: border-box;
  text-align: center;
  vertical-align: middle;
}

.#{$prefix}__selection-checkbox {
  height: $action-height;
  display: flex;
  align-items: center;
  justify-content: center;
}

.#{$prefix}__expand-cell {
  box-sizing: border-box;
  text-align: center;
  vertical-align: middle;
}

.#{$prefix}__expand-icon {
  @include button-utils.reset();

  width: 100%;
  height: $action-height;
  display: flex;
  align-items: center;
  justify-content: center;
  color: palette.semantic-variable(icon, neutral-strong);
  transition: transition.entrance(transform, moderate);

  &--expanded {
    transform: rotate(90deg);
  }
}

.#{$prefix}__expanded-row {
  & > &__cell {
    background-color: palette.semantic-variable("background", neutral-ghost);
    padding: spacing.semantic-variable(padding, vertical, calm) spacing.semantic-variable(padding, horizontal, base-fixed);
  }
}

.#{$prefix}__expanded-content {
  width: 100%;
}

.#{$prefix}__sort-icons {
  width: spacing.semantic-variable(size, element, base);
  height: spacing.semantic-variable(size, element, base);
  border: none;
  border-radius: radius.variable(base);
  background-color: transparent;
  padding: 0;
  display: flex;
  flex-direction: column;
  flex-shrink: 0;
  gap: 0;
  align-items: center;
  justify-content: center;
  cursor: pointer;

  &:hover {
    & > .#{$prefix}__sort-icon {
      color: palette.semantic-variable(icon, neutral-bold);
    }
  }

  &:focus-visible {
    outline: none;
    box-shadow: effect.variable(focus, primary);
  }
}

.#{$prefix}__sort-icon {
  color: palette.semantic-variable(icon, neutral-light);
  transition: transition.standard(color, fast);

  &--active {
    color: palette.semantic-variable(icon, neutral-bold);
  }
}

.#{$resize-handle-prefix} {
  position: absolute;
  right: 0;
  top: 50%;
  z-index: 1;
  height: 100%;
  padding: 0 spacing.semantic-variable(padding, horizontal, comfort);
  cursor: col-resize;
  user-select: none;
  transform: translate3d(50%, -50%, 0);
  transition: transition.standard(background-color);

  &::after {
    content: '';
    position: absolute;
    right: 50%;
    top: 50%;
    z-index: 1;
    transform: translate3d(50%, -50%, 0);
    width: var(--mzn-table-resize-handle-width);
    height: var(--mzn-table-resize-handle-height);
    border-radius: radius.variable(full);
    background-color: palette.semantic-variable(separator, neutral-faint);
    transition: transition.standard(background-color);
  }

  &:hover,
  &--active {
    &::after {
      background-color: palette.semantic-variable("background", brand);
    }
  }
}

.#{$prefix}__empty {
  min-height: 200px;
  text-align: center;
  vertical-align: middle;
}
