@use 'sass:map';
@use '../size';
@use '../palette';
@use '../typography';
@use '../icon';
@use '../typography/utils' as utils-typography;
@use './utils';

$prefix: mzn-textfield;
$inputSizes: size.$sizes;

$default-options: (
  padding-x: 16px,
  padding-x-small: 12px,
  padding-x-with-icon: 12px,
  padding-x-small-with-icon: 8px,
  icon-size: 24px,
  icon-size-small: 16px,
  padding-decorator: 4px,
  input-width: 160px,
  input-width-small: 132px,
  textarea-width: 452px,
  textarea-width-small: 388px,
  height: 100px,
);

@function _get-typography-variant-from-size($size) {
  @return map.get(
    (
      small: input3,
      medium: input2,
      large: input1,
    ),
    $size
  );
}

@mixin _padding-x($options, $is-outlined) {
  $padding-x: utils-typography.px-to-rem(map.get($options, padding-x));
  $padding-x-small: utils-typography.px-to-rem(map.get($options, padding-x-small));
  $padding-x-with-icon: utils-typography.px-to-rem(map.get($options, padding-x-with-icon));
  $padding-x-small-with-icon: utils-typography.px-to-rem(map.get($options, padding-x-small-with-icon));

  padding: 0 $padding-x;

  &.#{$prefix}--multiple {
    padding-top: 8px;
    padding-bottom: 8px;
  }

  &.#{$prefix}--prefix {
    padding-left: $padding-x-with-icon;
  }

  &.#{$prefix}--suffix {
    padding-right: $padding-x-with-icon;
  }

  &.#{$prefix}--small {
    padding: 0 $padding-x-small;

    &.#{$prefix}--multiple {
      padding-top: 8px;
      padding-bottom: 8px;
    }

    &.#{$prefix}--prefix {
      padding-left: $padding-x-small-with-icon;
    }

    &.#{$prefix}--suffix {
      padding-right: $padding-x-small-with-icon;
    }
  }
}

@mixin _size($options) {
  $icon-size: map.get($options, icon-size);
  $icon-size-small: map.get($options, icon-size-small);

  .#{icon.$prefix} {
    font-size: utils-typography.px-to-rem($icon-size);
  }

  @each $size in $inputSizes {
    $typography-variant: _get-typography-variant-from-size($size);

    &--#{$size} {
      @include typography.variant($typography-variant);

      @if $size == small {
        .#{icon.$prefix} {
          font-size: utils-typography.px-to-rem($icon-size-small);
        }
      }
    }
  }
}

@mixin _width($options) {
  $height: utils-typography.px-to-rem(map.get($options, height));
  $input-width: utils-typography.px-to-rem(map.get($options, input-width));
  $input-width-small: utils-typography.px-to-rem(map.get($options, input-width-small));
  $textarea-width: utils-typography.px-to-rem(map.get($options, textarea-width));
  $textarea-width-small: utils-typography.px-to-rem(map.get($options, textarea-width-small));

  min-width: $input-width;
  width: 100%;

  &.#{$prefix}--small {
    min-width: $input-width-small;
  }

  &.#{$prefix}--multiple {
    min-width: $textarea-width;
    width: 100%;
    min-height: $height;

    &.#{$prefix}--small {
      min-width: $textarea-width-small;
    }
  }
}

@mixin core($options: ()) {
  $options: map.deep-merge($default-options, $options);
  $padding-decorator: utils-typography.px-to-rem(map.get($options, padding-decorator));

  .#{$prefix} {
    @include utils.reset();
    @include _padding-x($options, false);
    @include _size($options);
    @include _width($options);

    ::placeholder {
      color: palette.color(text-secondary);
    }

    border-color: palette.color(border);
    background-color: palette.color(surface);

    &:focus-within {
      border-color: palette.color(error);

      button {
        opacity: 1;
        color: palette.color(error);
      }

      &:not(.#{$prefix}--error) {
        border-color: palette.color(primary);

        button {
          opacity: 1;
          color: palette.color(primary);
        }
      }
    }

    &.#{$prefix}--multiple {
      align-items: flex-start;
    }

    &:hover {
      &:not(.#{$prefix}--disabled) {
        &:hover {
          border-color: palette.color(primary);

          &.#{$prefix}--error {
            border-color: palette.color(error);
          }
        }

        .#{$prefix}--clearButton {
          opacity: 1;
          color: palette.color(primary);

          &.#{$prefix}--error {
            color: palette.color(error);
          }
        }
      }
    }

    &.#{$prefix}--error {
      border-color: palette.color(error);
    }

    &.#{$prefix}--disabled {
      border-color: transparent;
      background-color: palette.color(action-disabled-bg);

      ::placeholder {
        color: palette.color(text-disabled);
      }
    }

    &--clearButton {
      border: none;
      padding: 0;
      background-color: transparent;
      outline: none;
      cursor: pointer;
      opacity: 0;
    }

    .#{$prefix}--prefix {
      display: flex;
      justify-content: center;
      align-items: center;
      white-space: nowrap;
      color: var(--mzn-color-action-inactive);
      padding: 0 $padding-decorator 0 0;
    }

    .#{$prefix}--suffix {
      display: flex;
      justify-content: center;
      align-items: center;
      white-space: nowrap;
      color: var(--mzn-color-action-inactive);
      padding: 0 0 0 $padding-decorator;
    }

    &--counting {
      position: absolute;
      bottom: -20px;
      right: 0;

      &.#{$prefix}--disabled {
        color: palette.color(action-disabled-bg);
      }

      &.#{$prefix}--error {
        color: palette.color(error);
      }

      @include typography.variant(caption);
    }
  }
}
